services:
  pull-deploy:
    image: denoland/deno:alpine-2.6.5
    working_dir: /srv
    restart: "no"
    volumes:
      - /mnt/marble/appdata/web-sites/:/srv
    command: >
      sh -c "apk add --no-cache git &&
             if [ ! -d /srv/.git ]; then
               git clone --depth 1 https://github.com/aryadaroui/self-host-home-server /srv;
             else
               git -C /srv pull --ff-only;
             fi"

  aryadee-dev:
    image: denoland/deno:alpine-2.6.5
    working_dir: /srv
    restart: unless-stopped
    ports:
      - "3000:8000"
    volumes:
      - /mnt/marble/appdata/web-sites/:/srv
    command: >
      sh -c "cd /srv/web-sites/aryadee.dev &&
             deno install &&
             deno task build &&
             deno run --allow-env --allow-net --allow-read .deno-deploy/server.ts"
    healthcheck:
      test: ["CMD-SHELL", "deno eval 'await fetch(\"http://localhost:8000\")'"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      pull-deploy:
        condition: service_completed_successfully

  nathaliektherapy-com:
    image: denoland/deno:alpine-2.6.5
    working_dir: /srv
    restart: unless-stopped
    ports:
      - "3001:8000"
    volumes:
      - /mnt/marble/appdata/web-sites/:/srv
    command: >
      sh -c "cd /srv/web-sites/nathaliektherapy.com &&
             deno install &&
             deno task build &&
             deno run --allow-env --allow-net --allow-read .deno-deploy/server.ts"
    healthcheck:
      test: ["CMD-SHELL", "deno eval 'await fetch(\"http://localhost:8000\")'"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    depends_on:
      pull-deploy:
        condition: service_completed_successfully
